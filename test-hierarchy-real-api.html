<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Hierarchy API</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success { background: #dcfce7; border: 1px solid #16a34a; color: #15803d; }
        .error { background: #fef2f2; border: 1px solid #dc2626; color: #b91c1c; }
        .info { background: #dbeafe; border: 1px solid #2563eb; color: #1d4ed8; }
        pre {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 14px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Hierarchy API Test with Real Database</h1>
        <p>Testing the new hierarchical timeline system with real authentication and database.</p>
        
        <div id="status" class="status info">
            Ready to test...
        </div>

        <div>
            <button onclick="testHealth()">Test Health</button>
            <button onclick="testListNodes()">List Nodes</button>
            <button onclick="testCreateNode()">Create Test Node</button>
            <button onclick="testHierarchyIntegration()">Full Integration Test</button>
        </div>

        <div>
            <h3>Results:</h3>
            <pre id="results">Click a button to see results...</pre>
        </div>
    </div>

    <script>
        let results = document.getElementById('results');
        let status = document.getElementById('status');

        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function logResult(message) {
            results.textContent += message + '\n';
        }

        function clearResults() {
            results.textContent = '';
        }

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`/api/v2/timeline${endpoint}`, {
                    credentials: 'include', // Include cookies for session auth
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function testHealth() {
            clearResults();
            updateStatus('Testing health endpoint...', 'info');
            
            const result = await apiCall('/health');
            logResult(`Health Check:`);
            logResult(`Status: ${result.status}`);
            logResult(`Response: ${JSON.stringify(result.data || result.error, null, 2)}`);
            
            if (result.success) {
                updateStatus('‚úÖ Health check passed!', 'success');
            } else {
                updateStatus(`‚ùå Health check failed: ${result.error || result.data?.error}`, 'error');
            }
        }

        async function testListNodes() {
            clearResults();
            updateStatus('Fetching user nodes...', 'info');
            
            const result = await apiCall('/nodes');
            logResult(`List Nodes:`);
            logResult(`Status: ${result.status}`);
            
            if (result.success && result.data) {
                logResult(`Found ${result.data.length} nodes:`);
                result.data.forEach((node, i) => {
                    logResult(`  ${i + 1}. ${node.label} (${node.type}) - ID: ${node.id}`);
                });
                updateStatus(`‚úÖ Found ${result.data.length} nodes in database`, 'success');
            } else {
                logResult(`Error: ${JSON.stringify(result.data || result.error, null, 2)}`);
                updateStatus(`‚ùå Failed to list nodes: ${result.error || result.data?.error}`, 'error');
            }
        }

        async function testCreateNode() {
            clearResults();
            updateStatus('Creating test node...', 'info');
            
            const testNode = {
                type: 'project',
                label: 'Real API Integration Test',
                meta: {
                    description: 'Testing the new hierarchical timeline with real database',
                    technologies: ['React', 'TypeScript', 'React Flow', 'shadcn/ui'],
                    status: 'active'
                }
            };
            
            const result = await apiCall('/nodes', {
                method: 'POST',
                body: JSON.stringify(testNode)
            });
            
            logResult(`Create Node:`);
            logResult(`Status: ${result.status}`);
            
            if (result.success && result.data) {
                logResult(`‚úÖ Node created successfully:`);
                logResult(`  ID: ${result.data.id}`);
                logResult(`  Label: ${result.data.label}`);
                logResult(`  Type: ${result.data.type}`);
                logResult(`  Meta: ${JSON.stringify(result.data.meta, null, 2)}`);
                updateStatus('‚úÖ Test node created successfully!', 'success');
                
                // Clean up - delete the test node
                setTimeout(async () => {
                    await apiCall(`/nodes/${result.data.id}`, { method: 'DELETE' });
                    logResult(`üßπ Test node deleted`);
                }, 2000);
            } else {
                logResult(`Error: ${JSON.stringify(result.data || result.error, null, 2)}`);
                updateStatus(`‚ùå Failed to create node: ${result.error || result.data?.error}`, 'error');
            }
        }

        async function testHierarchyIntegration() {
            clearResults();
            updateStatus('Running full integration test...', 'info');
            
            logResult('üöÄ Starting Full Hierarchy Integration Test\n');
            
            // Test 1: Health check
            logResult('1. Testing health endpoint...');
            const health = await apiCall('/health');
            if (health.success) {
                logResult('   ‚úÖ Health check passed');
            } else {
                logResult('   ‚ùå Health check failed');
                updateStatus('‚ùå Integration test failed at health check', 'error');
                return;
            }
            
            // Test 2: List existing nodes
            logResult('\n2. Listing existing nodes...');
            const nodes = await apiCall('/nodes');
            if (nodes.success) {
                logResult(`   ‚úÖ Found ${nodes.data.length} existing nodes`);
            } else {
                logResult('   ‚ùå Failed to list nodes');
                updateStatus('‚ùå Integration test failed at node listing', 'error');
                return;
            }
            
            // Test 3: Create parent node
            logResult('\n3. Creating parent node (Career Transition)...');
            const parent = await apiCall('/nodes', {
                method: 'POST',
                body: JSON.stringify({
                    type: 'careerTransition',
                    label: 'Integration Test Career Change',
                    meta: {
                        description: 'Testing hierarchical relationships',
                        status: 'active'
                    }
                })
            });
            
            if (!parent.success) {
                logResult('   ‚ùå Failed to create parent node');
                updateStatus('‚ùå Integration test failed at parent creation', 'error');
                return;
            }
            logResult(`   ‚úÖ Parent created: ${parent.data.id}`);
            
            // Test 4: Create child node
            logResult('\n4. Creating child node (Project)...');
            const child = await apiCall('/nodes', {
                method: 'POST',
                body: JSON.stringify({
                    type: 'project',
                    label: 'Integration Test Project',
                    parentId: parent.data.id,
                    meta: {
                        description: 'Child node for testing hierarchy',
                        technologies: ['React Flow', 'Dagre', 'TypeScript'],
                        status: 'completed'
                    }
                })
            });
            
            if (!child.success) {
                logResult('   ‚ùå Failed to create child node');
            } else {
                logResult(`   ‚úÖ Child created: ${child.data.id}`);
                logResult(`   ‚úÖ Hierarchy relationship: ${child.data.parentId} ‚Üí ${child.data.id}`);
            }
            
            // Test 5: Update nodes
            logResult('\n5. Testing node updates...');
            const update = await apiCall(`/nodes/${parent.data.id}`, {
                method: 'PATCH',
                body: JSON.stringify({
                    meta: {
                        ...parent.data.meta,
                        status: 'completed'
                    }
                })
            });
            
            if (update.success) {
                logResult('   ‚úÖ Node update successful');
            } else {
                logResult('   ‚ùå Node update failed');
            }
            
            // Test 6: Clean up
            logResult('\n6. Cleaning up test nodes...');
            if (child.success) {
                await apiCall(`/nodes/${child.data.id}`, { method: 'DELETE' });
                logResult(`   üßπ Child node deleted: ${child.data.id}`);
            }
            await apiCall(`/nodes/${parent.data.id}`, { method: 'DELETE' });
            logResult(`   üßπ Parent node deleted: ${parent.data.id}`);
            
            logResult('\nüéâ Integration test completed successfully!');
            logResult('\nThe hierarchical timeline system is working correctly with:');
            logResult('  ‚úÖ Real database connections');
            logResult('  ‚úÖ Authentication system');
            logResult('  ‚úÖ Hierarchy relationships');
            logResult('  ‚úÖ CRUD operations');
            logResult('  ‚úÖ Meta-driven data model');
            
            updateStatus('üéâ Full integration test passed!', 'success');
        }

        // Auto-run a quick test when page loads
        setTimeout(testHealth, 1000);
    </script>
</body>
</html>